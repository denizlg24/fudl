// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  sessions      Session[]
  accounts      Account[]

  // Profile details
  sport           String?
  city            String?
  country         String?
  heightCm        Int?
  weightKg        Float?
  dateOfBirth     DateTime?
  bio             String?
  position        String?
  jerseyNumber    Int?
  instagramHandle String?
  twitterHandle   String?

  members     Member[]
  invitations Invitation[]
  videos      Video[]
  inviteLinks InviteLink[]
  annotations Annotation[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  activeOrganizationId String?

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Organization {
  id          String       @id
  name        String
  slug        String
  logo        String?
  createdAt   DateTime
  metadata    String?
  members     Member[]
  invitations Invitation[]
  inviteLinks InviteLink[]
  seasons     Season[]
  games       Game[]
  videos      Video[]
  clips       Clip[]
  tags        Tag[]
  annotations Annotation[]

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String       @default("member")
  createdAt      DateTime

  @@index([organizationId])
  @@index([userId])
  @@map("member")
}

model Invitation {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String       @default("pending")
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@map("invitation")
}

model InviteLink {
  id             String       @id @default(cuid())
  token          String       @unique
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdById    String?
  createdBy      User?        @relation(fields: [createdById], references: [id], onDelete: SetNull)
  role           String       @default("member")
  maxUses        Int          @default(25)
  useCount       Int          @default(0)
  expiresAt      DateTime
  revokedAt      DateTime?
  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([token])
  @@map("invite_link")
}

// ===========================================================================
// Domain Models
// ===========================================================================

model Season {
  id             String       @id @default(cuid())
  name           String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  games          Game[]

  @@index([organizationId])
  @@map("season")
}

model Game {
  id             String       @id @default(cuid())
  title          String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  seasonId       String
  season         Season       @relation(fields: [seasonId], references: [id], onDelete: Restrict)
  date           DateTime?
  location       String?
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  videos         Video[]
  tags           TagsOnGames[]

  @@index([organizationId])
  @@index([seasonId])
  @@map("game")
}

enum VideoStatus {
  PENDING
  UPLOADING
  UPLOADED
  PROCESSING
  COMPLETED
  FAILED
}

model Video {
  id             String       @id @default(cuid())
  title          String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  gameId         String?
  game           Game?        @relation(fields: [gameId], references: [id], onDelete: SetNull)
  uploadedById   String?
  uploadedBy     User?        @relation(fields: [uploadedById], references: [id], onDelete: SetNull)

  // Storage
  storageKey     String?
  storageUrl     String?
  mimeType       String?
  fileSize        BigInt?
  durationSecs   Float?
  thumbnailKey   String?
  thumbnailUrl   String?
  width          Int?
  height         Int?
  fps            Float?
  codec          String?

  // Processing
  status         VideoStatus  @default(PENDING)
  jobId          String?
  errorMessage   String?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  uploadSession  UploadSession?
  clips          Clip[]
  tags           TagsOnVideos[]
  annotations    Annotation[]

  @@index([organizationId])
  @@index([gameId])
  @@index([uploadedById])
  @@index([status])
  @@map("video")
}

model UploadSession {
  id             String   @id @default(cuid())
  videoId        String   @unique
  video          Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  s3UploadId     String
  s3Key          String
  totalParts     Int
  partSize       Int
  completedParts Json     @default("[]") // Array of {partNumber, etag}
  totalBytes     BigInt
  uploadedBytes  BigInt   @default(0)
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([videoId])
  @@map("upload_session")
}

model Clip {
  id             String       @id @default(cuid())
  videoId        String
  video          Video        @relation(fields: [videoId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  playNumber     Int
  title          String?
  startTime      Float
  endTime        Float
  storageKey     String?
  storageUrl     String?
  thumbnailKey   String?
  thumbnailUrl   String?
  labels         Json         @default("[]")
  metadata       Json         @default("{}")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([videoId, playNumber])
  @@index([organizationId])
  @@map("clip")
}

// ===========================================================================
// Annotations
// ===========================================================================

model Annotation {
  id             String       @id @default(cuid())
  videoId        String
  video          Video        @relation(fields: [videoId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdById    String
  createdBy      User         @relation(fields: [createdById], references: [id], onDelete: Cascade)
  timestamp      Float
  data           Json
  isPrivate      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([videoId, timestamp])
  @@index([organizationId])
  @@map("annotation")
}

// ===========================================================================
// Tag System
// ===========================================================================

enum TagCategory {
  OPPONENT
  FIELD
  CAMERA_ANGLE
  GENERAL
}

model Tag {
  id             String       @id @default(cuid())
  name           String
  category       TagCategory
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())

  games  TagsOnGames[]
  videos TagsOnVideos[]

  @@unique([organizationId, category, name])
  @@index([organizationId, category])
  @@map("tag")
}

model TagsOnGames {
  gameId String
  game   Game   @relation(fields: [gameId], references: [id], onDelete: Cascade)
  tagId  String
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([gameId, tagId])
  @@index([tagId])
  @@map("tags_on_games")
}

model TagsOnVideos {
  videoId String
  video   Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)
  tagId   String
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([videoId, tagId])
  @@index([tagId])
  @@map("tags_on_videos")
}
